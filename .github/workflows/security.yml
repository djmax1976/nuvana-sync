name: Security Scanning

# Comprehensive security scanning pipeline
# Triggers only on PRs to main (solo developer workflow - no duplicate runs)
# Also runs daily for continuous security monitoring
on:
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC for continuous security monitoring
    - cron: '0 2 * * *'
  workflow_dispatch: # Manual trigger for testing

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions for all jobs (jobs can override with more specific permissions)
permissions:
  contents: read
  security-events: write
  pull-requests: read

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Semgrep SAST (Static Application Security Testing)
  # ============================================================================
  semgrep-sast:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep SAST
        id: semgrep
        run: |
          pip install semgrep

          # Run Semgrep with custom rules only (community rules removed - too noisy)
          # Output JSON for blocking logic
          semgrep scan \
            --config=.semgrep/ \
            --json \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='*.spec.ts' \
            --exclude='*.spec.tsx' \
            --exclude='tests/' \
            . > semgrep.json 2>&1 || true

          # Check for ERROR severity findings (blocking)
          # Handle case where semgrep.json doesn't exist or is invalid
          if [ -f semgrep.json ] && jq empty semgrep.json 2>/dev/null; then
            ERROR_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep.json)
            WARNING_COUNT=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep.json)
          else
            echo "::warning::Semgrep output is invalid or missing"
            ERROR_COUNT=0
            WARNING_COUNT=0
          fi

          # Ensure counts are numbers, default to 0
          ERROR_COUNT=${ERROR_COUNT:-0}
          WARNING_COUNT=${WARNING_COUNT:-0}

          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT

          echo "Semgrep found $ERROR_COUNT errors and $WARNING_COUNT warnings"

          # Display findings for visibility
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::error::Semgrep found $ERROR_COUNT high-severity security issues"
            jq '.results[] | select(.extra.severity == "ERROR") | {rule: .check_id, file: .path, line: .start.line, message: .extra.message}' semgrep.json
          fi

          if [ "$WARNING_COUNT" -gt 0 ]; then
            echo "::warning::Semgrep found $WARNING_COUNT medium-severity security issues"
          fi

          # Generate SARIF for GitHub code scanning (separate run)
          semgrep scan \
            --config=.semgrep/ \
            --sarif \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='*.spec.ts' \
            --exclude='*.spec.tsx' \
            --exclude='tests/' \
            . > semgrep.sarif 2>&1 || true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      - name: Fail on high-severity findings
        if: steps.semgrep.outputs.error_count != '0' && steps.semgrep.outputs.error_count != ''
        run: |
          echo "::error::Blocking PR due to ${{ steps.semgrep.outputs.error_count }} high-severity Semgrep findings"
          echo "Review the Semgrep results above and fix the security issues before merging."
          exit 1

  # ============================================================================
  # CodeQL Analysis (GitHub's SAST)
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: +security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:javascript-typescript'
        continue-on-error: true # Don't fail if code scanning is not enabled in repo settings

  # ============================================================================
  # Dependency Vulnerability Scanning
  # ============================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Retry npm ci up to 3 times to handle transient network errors (e.g., 502 Bad Gateway)
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            npm ci && break || {
              if [ $i -lt 3 ]; then
                echo "npm ci failed, retrying in 10 seconds..."
                sleep 10
              else
                echo "npm ci failed after 3 attempts"
                exit 1
              fi
            }
          done

      # ================================================================
      # PRODUCTION DEPENDENCIES AUDIT (BLOCKING)
      # These are dependencies that ship with the Electron app
      # Per GOV-003: Fail on high/critical vulnerabilities in production code
      # ================================================================
      - name: NPM Audit - Production Dependencies (Blocking)
        id: prod-audit
        run: |
          echo "=== Auditing PRODUCTION dependencies (--omit=dev) ==="
          echo "These dependencies ship with the application and affect end users."
          echo ""

          # Audit production dependencies only
          npm audit --omit=dev --json > npm-audit-prod.json 2>&1 || true

          # Extract vulnerability counts
          PROD_HIGH=$(cat npm-audit-prod.json | jq '.metadata.vulnerabilities.high // 0')
          PROD_CRITICAL=$(cat npm-audit-prod.json | jq '.metadata.vulnerabilities.critical // 0')
          PROD_MODERATE=$(cat npm-audit-prod.json | jq '.metadata.vulnerabilities.moderate // 0')
          PROD_LOW=$(cat npm-audit-prod.json | jq '.metadata.vulnerabilities.low // 0')

          echo "Production dependency vulnerabilities:"
          echo "  Critical: $PROD_CRITICAL"
          echo "  High: $PROD_HIGH"
          echo "  Moderate: $PROD_MODERATE"
          echo "  Low: $PROD_LOW"

          # Output for summary
          echo "prod_critical=$PROD_CRITICAL" >> $GITHUB_OUTPUT
          echo "prod_high=$PROD_HIGH" >> $GITHUB_OUTPUT

          # BLOCKING: Fail on critical vulnerabilities in production
          if [ "$PROD_CRITICAL" -gt 0 ]; then
            echo ""
            echo "::error::CRITICAL vulnerabilities found in PRODUCTION dependencies!"
            echo "These vulnerabilities ship to end users and MUST be fixed."
            cat npm-audit-prod.json | jq '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | {package: .key, severity: .value.severity, via: .value.via, fixAvailable: .value.fixAvailable}'
            exit 1
          fi

          # BLOCKING: Fail on high vulnerabilities in production
          if [ "$PROD_HIGH" -gt 0 ]; then
            echo ""
            echo "::error::HIGH severity vulnerabilities found in PRODUCTION dependencies!"
            echo "These vulnerabilities ship to end users and MUST be fixed."
            cat npm-audit-prod.json | jq '.vulnerabilities | to_entries[] | select(.value.severity == "high") | {package: .key, severity: .value.severity, via: .value.via, fixAvailable: .value.fixAvailable}'
            exit 1
          fi

          echo ""
          echo "✅ No high/critical vulnerabilities in production dependencies."

      # ================================================================
      # DEVELOPMENT DEPENDENCIES AUDIT (NON-BLOCKING, INFORMATIONAL)
      # These are build tools, linters, test frameworks that don't ship
      # Per GOV-003: Track for compliance, but don't block pipeline
      # ================================================================
      - name: NPM Audit - Development Dependencies (Informational)
        id: dev-audit
        run: |
          echo "=== Auditing ALL dependencies (including devDependencies) ==="
          echo "Development dependencies are used only during build/test."
          echo "They do NOT ship with the application."
          echo ""

          # Full audit for tracking/compliance
          npm audit --json > npm-audit-full.json 2>&1 || true

          # Extract counts
          FULL_HIGH=$(cat npm-audit-full.json | jq '.metadata.vulnerabilities.high // 0')
          FULL_CRITICAL=$(cat npm-audit-full.json | jq '.metadata.vulnerabilities.critical // 0')
          DEV_HIGH=$((FULL_HIGH - ${{ steps.prod-audit.outputs.prod_high || 0 }}))
          DEV_CRITICAL=$((FULL_CRITICAL - ${{ steps.prod-audit.outputs.prod_critical || 0 }}))

          echo "Development-only dependency vulnerabilities:"
          echo "  Critical: $DEV_CRITICAL"
          echo "  High: $DEV_HIGH"

          # Output for summary
          echo "dev_critical=$DEV_CRITICAL" >> $GITHUB_OUTPUT
          echo "dev_high=$DEV_HIGH" >> $GITHUB_OUTPUT

          # Non-blocking warning for dev dependency vulnerabilities
          if [ "$DEV_CRITICAL" -gt 0 ]; then
            echo ""
            echo "::warning::Found $DEV_CRITICAL critical vulnerabilities in DEVELOPMENT dependencies."
            echo "These affect build/test environments only, not production."
            echo "Consider updating when feasible (major version upgrades may be required)."
          fi

          if [ "$DEV_HIGH" -gt 0 ]; then
            echo ""
            echo "::warning::Found $DEV_HIGH high vulnerabilities in DEVELOPMENT dependencies."
            echo "These affect build/test environments only, not production."
            echo "Affected packages (for tracking):"
            cat npm-audit-full.json | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high") | "  - \(.key): \(.value.via[0] | if type == "object" then .title else . end)"' | head -20
          fi

          echo ""
          echo "ℹ️ Development dependency vulnerabilities tracked but not blocking."
          echo "   Run 'npm audit' locally to see full details."

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-reports
          path: |
            npm-audit-prod.json
            npm-audit-full.json
          retention-days: 30

  # ============================================================================
  # Secret Scanning (GitLeaks)
  # ============================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: false
          GITLEAKS_CONFIG: .gitleaks.toml

  # ============================================================================
  # License Compliance Scanning
  # ============================================================================
  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Retry npm ci up to 3 times to handle transient network errors (e.g., 502 Bad Gateway)
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            npm ci && break || {
              if [ $i -lt 3 ]; then
                echo "npm ci failed, retrying in 10 seconds..."
                sleep 10
              else
                echo "npm ci failed after 3 attempts"
                exit 1
              fi
            }
          done

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          # Generate license report
          license-checker --json --out licenses.json

          # Check for problematic licenses
          PROBLEMATIC_LICENSES="GPL-3.0|AGPL|SSPL|BUSL|Commons Clause"

          if license-checker --summary | grep -E "$PROBLEMATIC_LICENSES"; then
            echo "::warning::Found potentially problematic licenses. Review licenses.json"
          fi

          # Fail on unknown licenses (could be proprietary)
          UNKNOWN=$(license-checker --unknown --json | jq 'length')
          if [ "$UNKNOWN" -gt 0 ]; then
            echo "::warning::Found $UNKNOWN packages with unknown licenses"
            license-checker --unknown
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  # ============================================================================
  # SBOM Generation (Software Bill of Materials)
  # ============================================================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Retry npm ci up to 3 times to handle transient network errors (e.g., 502 Bad Gateway)
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            npm ci && break || {
              if [ $i -lt 3 ]; then
                echo "npm ci failed, retrying in 10 seconds..."
                sleep 10
              else
                echo "npm ci failed after 3 attempts"
                exit 1
              fi
            }
          done

      - name: Generate CycloneDX SBOM
        run: |
          npx @cyclonedx/cyclonedx-npm --output-file sbom.json --output-format json
          npx @cyclonedx/cyclonedx-npm --output-file sbom.xml --output-format xml

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.json
            sbom.xml
          retention-days: 90

  # ============================================================================
  # Electron-Specific Security Checks
  # ============================================================================
  electron-security:
    name: Electron Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Electron security best practices
        run: |
          echo "Checking Electron security configurations..."

          # Check for nodeIntegration (should be false)
          if grep -r "nodeIntegration.*true" src/main --include="*.ts"; then
            echo "::error::nodeIntegration should be false for security"
            exit 1
          fi

          # Check for contextIsolation (should be true)
          if grep -r "contextIsolation.*false" src/main --include="*.ts"; then
            echo "::error::contextIsolation should be true for security"
            exit 1
          fi

          # Check for sandbox (should be true)
          if grep -r "sandbox.*false" src/main --include="*.ts"; then
            echo "::warning::sandbox should generally be true for security"
          fi

          # Check for webSecurity (should be true/not disabled)
          if grep -r "webSecurity.*false" src/main --include="*.ts"; then
            echo "::error::webSecurity should not be disabled"
            exit 1
          fi

          # Check for allowRunningInsecureContent
          if grep -r "allowRunningInsecureContent.*true" src/main --include="*.ts"; then
            echo "::error::allowRunningInsecureContent should be false"
            exit 1
          fi

          # Check for remote module (deprecated, security risk)
          if grep -r "enableRemoteModule.*true" src/main --include="*.ts"; then
            echo "::error::enableRemoteModule is deprecated and a security risk"
            exit 1
          fi

          echo "Electron security checks passed!"
        shell: bash

      - name: Check preload script security
        run: |
          echo "Checking preload script security..."

          # Ensure contextBridge is used
          if ! grep -r "contextBridge" src/preload --include="*.ts"; then
            echo "::error::Preload scripts should use contextBridge for secure IPC"
            exit 1
          fi

          # Check for dangerous patterns in preload
          if grep -r "require\s*(" src/preload --include="*.ts" | grep -v "electron"; then
            echo "::warning::Direct require() in preload should be avoided"
          fi

          echo "Preload security checks passed!"
        shell: bash

  # ============================================================================
  # Security Summary
  # ============================================================================
  security-summary:
    name: Security Summary
    needs:
      [semgrep-sast, codeql, dependency-audit, secret-scan, license-scan, sbom, electron-security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Security scan summary
        run: |
          echo "Security Scan Results:"
          echo "  Semgrep SAST: ${{ needs.semgrep-sast.result }}"
          echo "  CodeQL: ${{ needs.codeql.result }}"
          echo "  Dependency Audit: ${{ needs.dependency-audit.result }}"
          echo "  Secret Scan: ${{ needs.secret-scan.result }}"
          echo "  License Compliance: ${{ needs.license-scan.result }}"
          echo "  SBOM Generation: ${{ needs.sbom.result }}"
          echo "  Electron Security: ${{ needs.electron-security.result }}"

          # Fail if any critical security check failed
          # Semgrep and Electron security are blocking
          # CodeQL is optional (may fail if code scanning not enabled in repo)
          # Note: Secret scan uses .gitleaks.toml for false positive exclusions
          if [ "${{ needs.semgrep-sast.result }}" == "failure" ] || \
             [ "${{ needs.dependency-audit.result }}" == "failure" ] || \
             [ "${{ needs.electron-security.result }}" == "failure" ]; then
            echo "::error::Critical security checks failed"
            exit 1
          fi

          # Warn on secret scan failures (may have false positives)
          if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            echo "::warning::Secret scan reported findings - review gitleaks results"
          fi

          echo "Security scanning completed"
        shell: bash
